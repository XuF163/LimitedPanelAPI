server:
  port: 4567
  host: 0.0.0.0
  enabled: true
  ui:
    enabled: true
    # 默认仅允许本机访问 WebUI（推荐）。如需远程访问，请开启并设置 token。
    allowRemote: false
    token: ""

meta:
  autoSync: true
  autoUpdate:
    # 每隔一段时间自动同步 meta（git fetch/reset，相当于“每天 pull 一次”）
    enabled: false
    intervalSec: 86400
  # GS/SR meta 来源选择：
  # - cnb：从 CNB（qsyhh_res/meta）拉取（默认）
  # - miao-plugin：从 miao-plugin 仓库/目录拷贝 resources/meta-gs & resources/meta-sr
  source:
    type: cnb

    cnb:
      repo: https://cnb.cool/qsyhh_res/meta.git
      branch:
        gs: meta-gs
        sr: meta-sr

    miaoPlugin:
      # miao-plugin 根目录（你自己 clone 下来的目录）。
      # 为空则会尝试自动使用：<YunzaiRoot>/plugins/miao-plugin
      dir: ""
      # 当 dir 为空且本机不存在 miao-plugin 时，会 clone 到这里再取 meta：
      git:
        repo: https://github.com/yoimiya-kokomi/miao-plugin.git
        ref: master
        dir: ./resources/miao-plugin

samples:
  # "playerdata" | "enka"
  mode: enka
  alwaysSample: true

  playerdata:
    # 为空则自动使用：<YunzaiRoot>/data/PlayerData/<game>
    dir: ""
    # 0 表示不限制
    maxFiles: 0

  enka:
    # UID 选择：分游戏配置（GS/SR=9 位；ZZZ=8 位）
    gs:
      # 两种方式二选一：
      # 1) uids: [242422996, ...]
      uids: []
      # 2) uidStart + uidEnd（会被 maxCount 截断，避免扫描超大范围导致 OOM）
      uidStart: null
      uidEnd: null
    sr:
      uids: []
      uidStart: null
      uidEnd: null
    zzz:
      uids: []
      uidStart: null
      uidEnd: null

    maxCount: 20000
    # v2：并发改为“自适应 + 指数退避”，不再提供手动并发上限。
    # - 有代理时：吞吐主要受「可用代理数 × 每桶 delayMs」影响
    # - 无代理时：通过 scan.sqlite 的全局限速(noProxyDelayMs) 保守运行
    # 每次启动优先重试的 UID 数（来自 sqlite 的 next_retry_at 队列）
    retryFirst: 1
    # 有代理时：这是“每个代理桶”的请求间隔
    delayMs: 20000
    # 无代理/无可用节点时：全局限速（跨 gs/sr/zzz、跨进程），避免直连触发 429
    noProxyDelayMs: 20000
    jitterMs: 2000
    # 单次请求超时时间（毫秒）。为空/0 则使用默认值。
    timeoutMs: 15000
    # 是否将原始响应写入 sqlite（推荐开启）
    storeRawDb: true
    # 是否将原始响应另存为 data/raw/<game>/<uid>.json（大规模扫描不推荐）
    saveRawFile: false
    # 简易熔断：避免上游整体不可用时浪费长时间扫描
    circuitBreaker:
      maxConsecutiveFails: 5
      breakOn429: true

    # 定期重扫：用于“刷新样本 -> 更新极限面板”（仅对已扫描过、且超过一定时间未更新的 UID 生效）
    rescan:
      enabled: false
      # 认为“过期”的最小间隔（秒）。例如 86400=一天
      afterSec: 86400
      # 每次运行优先重扫多少个 UID（按 last_checked_at 最旧优先）
      first: 20000

    # 每日扫描终止线：当默认极限面板（out/<game>/<preset.uid>.json）中
    # 所有 meta 角色都达到阈值后，当天不再继续扫描该游戏。
    # - 触发/更新时机：每次 preset:generate 后写入 scan.sqlite 的 scan_daily_gate 表
    # - 跳过扫描逻辑：start.js 的自动采样会读取 scan_daily_gate 并在当天直接跳过
    dailyGate:
      enabled: false
      threshold:
        gs: 300
        sr: 300
        zzz: 590

preset:
  uid: "100000000"
  name: 极限面板
  alwaysGenerate: true
  limitChars: 0
  autoRefresh:
    # 周期性执行：采样（samples）+ 生成（preset），用于持续更新 out/<game>/<uid>.json
    enabled: false
    # 间隔（秒）。例如 3600=每小时
    intervalSec: 3600
    # 是否在进程启动后立刻跑一次（不建议；start.js 本身已经会跑一轮）
    runOnStart: false
    # 强制执行（忽略 samples.alwaysSample / preset.alwaysGenerate）
    force: true

# 绝区零（ZZZ）源数据（用于：Enka -> 面板转换、驱动盘评分/强化规则、专武识别等）
zzz:
  source:
    # yunzai-plugin: 使用本地 Yunzai 的 plugins/ZZZ-Plugin
    # github: 自动从 GitHub 拉取 ZZZ-Plugin 到本项目 resources 目录
    type: yunzai-plugin

    # type=yunzai-plugin 时生效；留空则默认：<YunzaiRoot>/plugins/ZZZ-Plugin
    pluginDir: ""

    # type=github 时生效
    github:
      repo: https://github.com/ZZZure/ZZZ-Plugin.git
      ref: main
      dir: ./resources/zzz-plugin
      autoSync: true

# 代理（v2ray-core，可选）
proxy:
  enabled: false
  # enabled=true 且 required=true 时，如果没有可用节点会直接报错退出
  required: false
  # 代理内核：v2ray（当前默认）/ mihomo（Clash Meta）/ auto（按节点类型自动选择）
  core: auto
  # 是否把代理配置落地到项目目录（data/proxy）。默认关闭以避免大量配置文件造成卡顿。
  keepConfigFiles: false
  # 代理节点启动/测活记录存储（SQLite）
  db:
    # 留空则默认：./data/proxy.sqlite
    path: ""
  v2ray:
    # Windows 64 位默认下载地址
    downloadUrl: https://github.com/v2fly/v2ray-core/releases/download/v5.44.1/v2ray-windows-64.zip
    binDir: ./bin/v2ray
    logLevel: warning
    basePort: 17890
  mihomo:
    # Mihomo（Clash Meta）下载地址：留空或 auto 表示从 GitHub latest 自动解析 Windows amd64 zip
    downloadUrl: auto
    binDir: ./bin/mihomo
    logLevel: warning
  subscription:
    # 订阅链接列表（支持：base64/vmess/vless/trojan/ss、以及 Clash YAML 的 proxies:）
    urls: []
    # 订阅拉取超时（毫秒）
    timeoutMs: 30000
    # 订阅拉取时使用的 HTTP 代理（例如：http://127.0.0.1:10808）。留空则直连；也可用环境变量 PROXY_SUB_HTTP_PROXY。
    httpProxy: ""
    # 允许订阅站 TLS 证书错误（curl -k）。默认关闭；仅在你确定订阅来源可信时开启。
    # 解决某些站点在 Windows/curl schannel 下报错：SEC_E_WRONG_PRINCIPAL。
    insecureSkipVerify: false
    # 拉取失败时允许使用本地缓存（更抗网络抖动/对方偶发 reset）
    useCacheOnFail: true
    # 订阅缓存目录（按 URL hash 保存原始文本）
    cacheDir: ./data/proxy/subscription-cache
    # 缓存 TTL（秒）；0 表示不限制（只要文件存在就可用）
    cacheTtlSec: 0
    # 最多保留多少个可用节点作为代理池（auto/0 表示使用默认值；也可用环境变量 PROXY_POOL_SIZE 覆盖）
    maxNodes: 30
    # 最多探测多少个节点（从订阅里按顺序取前 N 个探测，直到凑满 maxNodes）
    probeCount: 20
    # 探测轮数：当订阅前缀节点大面积不可用时，使用“spread”策略会把探测名额分布到全列表。
    # 例如 probeCount=20, probeRounds=3 => 最多探测约 60 个不同节点，直到凑满 maxNodes。
    probeRounds: 3
    # 节点选择策略：first=只测前 N 个；spread=把 N 个探测名额均匀分布在整个订阅列表
    pickStrategy: spread
    # 启动/测活并发（避免逐个节点启动导致耗时过长）
    startConcurrency: 6
    # 连续传输失败阈值：超过后禁用该代理（越大越“耐用”，但坏代理会拖慢整体）
    maxConsecutiveFails: 30
    # 建议用 API 地址做测活（403/404 也算“可连通”）
    testUrl: https://enka.network/api/uid/100000001
    testTimeoutMs: 8000

# QA：代理池 + 扫描 + 极限面板生成 + 对比梁氏预设
qa:
  games: [gs, sr]
  uid: "100000000"
  # ZZZ 的预设 UID（8 位）
  uidZzz: "10000000"
  scan:
    # QA 扫描使用的 SQLite（避免每次跑脚本生成一堆 scan.qa.*.sqlite）
    dbPath: ./data/scan.qa.sqlite
    # 每次运行是否重置（删除旧 DB 文件；建议开启保证结果独立）
    dbReset: true
    # 批次大小（每批调用一次 sample:collect）
    batchSize: 2000
    # 每次 sample:collect 的实际 count（用于更频繁输出进度；<= batchSize）
    stepSize: 200
    # 每个代理的请求间隔（毫秒）。总吞吐量≈代理数 / delayMs
    delayMs: 3000
    # v2：并发由系统自适应调节（指数退避），不再提供手动并发上限。
    # 单次 Enka 请求超时（毫秒）
    enkaTimeoutMs: 15000
    gs:
      uidStart: 100000001
      maxUids: 2000
      targetChars: 80
    sr:
      uidStart: 100000001
      maxUids: 2000
      targetChars: 60
    zzz:
      uidStart: 10000000
      maxUids: 500
      targetChars: 20
  verify:
    # diff: 对比我方评分 vs liangshi 评分的绝对差
    # miao: 统一用 miao-plugin 的圣遗物评分，做阈值合格率统计
    mode: miao
    gs:
      threshold: 300
      tolerance: 5
      minCommon: 10
      passRate: 0.8
    sr:
      # 注意：SR 的 mark 量级比 GS 大很多，tolerance 需要单独配置
      threshold: 300
      tolerance: 500
      minCommon: 10
      passRate: 0.5
    zzz:
      # ZZZ：暂无梁氏基线，校验规则为「高分 + 盘面强化规律 +（可选）专武」
      minMark: 590
      requireSignature: true
      requirePattern: true
      minAvatars: 5
      passRate: 1
