# TS v2 实施清单（直到“重构完成”）

> 更新时间：2026-01-22  
> 说明：本文档用于指导实现与验收；当前仓库已进入“改代码”阶段，并已落地本轮 v2 重构实现。

本清单与 `docs/重构计划.md` 一致，目标是完成 **TypeScript 第二次重构**，并落地：

- 自适应并发 + 指数退避（不允许手动设置并发上限）
- 动态扩充代理池（运行期补齐/淘汰/轮换闭环）
- 前后端目录结构优化（server/ui/shared/core/compat）

---

## 0. 完成定义（Definition of Done）

满足以下条件可认为“重构完成”：

1) **运行期只依赖 TS 产物**
- 运行入口只加载 `dist/`（或等价编译目录），不再运行 `src/*.js` 的旧实现链路
- `rust/` 不再参与启动，不需要 Rust 工具链

2) **兼容性达标**
- 产物 JSON（`/<game>/hyperpanel`、`/presets/<game>/<uid>.json`）结构与现有 `PlayerData` 兼容
- 对旧数据（SQLite/raw/samples/外部插件资源）的解析入口统一收口到 `compat/`，遇到坏数据可降级但不崩溃

3) **并发与稳定性达标**
- 无“并发上限”可配置项/接口参数（用户不可手调并发上限）
- 存在可观测的自适应并发状态与退避状态（WebUI/接口/日志至少满足其一）

4) **代理池闭环达标**
- ProxyPool ⇄ Scanner 闭环：扫描失败能触发代理降权/禁用；池不足能持续探测补齐

5) **文档收口**
- `docs/config.md`、`docs/webui-api.md`、`docs/开发计划.md` 与最终实现一致
- “旧版 Rust/手动并发”相关文档内容已删除或明确标注为废弃

---

## 1. 里程碑与任务拆解

### M1：目录分层落地（不改业务逻辑）

- [ ] 新增 `src/shared/`：错误码、日志字段规范、公共类型（先定义，不强绑实现）
- [ ] 新增 `src/compat/`：对外部输入的 normalize/guard（unknown-safe）
- [ ] 新增 `src/core/`：scanner/proxy/preset 逻辑迁移的目标落点（先建骨架）
- [ ] 新增 `src/server/`：HTTP 路由与 WebUI 静态托管落点（先把路由聚合到一处）
- [x] 明确 `src/ui/`：WebUI 静态资源（`index.html` + assets）

验收：
- [ ] 文档中所有“建议目录”与仓库结构一致（不要求功能完成）

### M2：兼容层收口（JS 源数据更好兼容）

- [ ] 为所有外部输入定义 `compat` 入口（至少：Enka raw、SQLite raw、samples jsonl、proxy nodes）
- [ ] 统一错误分类（至少：429 / 424 / timeout / html-waf / invalid-json / transport）
- [ ] 所有 compat 解析失败必须返回可解释的错误对象（可用于统计/展示），禁止 throw 泄漏到顶层

验收：
- [ ] 对“坏输入样本”进行回归：服务不崩溃；能记录错误分类；能继续处理后续任务

### M3：自适应并发 + 指数退避（替代手动并发）

- [x] 删除/忽略 `samples.enka.concurrency`、`samples.enka.fetcher` 等旧字段（至少在实现中不生效）
- [x] 实现“并发控制器”：根据 success/429/timeout/errorRate/proxyPoolSize 动态调节
- [x] 实现指数退避（带 jitter），避免 429 风暴
- [x] 增加可观测输出：并发、退避等级、近 1min 指标

验收：
- [ ] WebUI/API 能看到“当前并发 + 退避状态”
- [ ] 用户无法通过配置/接口设置并发上限

### M4：代理池动态扩容闭环

- [x] 代理池从“启动时固定”升级为“运行期维持目标容量”
- [ ] Scanner 失败反馈到 ProxyPool（降权/禁用/统计）
- [x] Pool 不足自动探测补齐；低质量节点自动轮换

验收：
- [ ] 运行一段时间后池规模可自动补齐；坏节点被剔除；扫描吞吐趋于稳定

### M5：清理与文档收口

- [x] 清理 `rust/` 目录与 Rust 相关环境变量/配置项（实现与文档同步）
- [x] 更新 docs：配置字段、WebUI API、开发计划与目录结构说明全部对齐

验收：
- [ ] `docs/config.md` 不再出现 Rust fetcher / parser 的“可用配置项”
- [ ] `docs/webui-api.md` 的接口清单与实现一致（区分“已实现/计划中”）

---

## 2. WebUI/API（v2）补齐项（建议）

> 目的：让“自动并发/退避/代理池”的行为可观测、可控（控制≠调参并发上限）。

- [x] `GET /api/runtime/status`：总体状态（proxyPool/scanner/preset/adaptiveConcurrency）
- [x] `GET /api/proxy/pool/status`：池状态（目标数/可用数/错误分布/禁用统计）
- [x] `POST /api/proxy/pool/rebuild`：重建池（不等同于提升并发）
- [x] `POST /api/samples/start`、`POST /api/samples/stop`：启动/停止扫描任务
- [x] `POST /api/presets/generate`：触发生成（支持按 game）

---
